name: ğŸš€ Deploy to Fabric

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        required: true
        default: dev
        options:
          - dev
          - prd
      workspace:
        type: string
        required: true
        default: "MyWorkspace"
      capacity:
        type: string
        required: false
        default: ""
      admin_upns:
        type: string
        required: false
        default: ""

jobs:
  deploy:
    name: ğŸŒ Deploy to Fabric (Semantic Model + Report)
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout code
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # 2) Install Python
      - name: ğŸ Install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      # 3) Install Fabric CLI (binary version)
      - name: ğŸ“¦ Install Fabric CLI
        run: |
          wget https://aka.ms/fabriccli_linux -O fabric
          chmod +x fabric
          sudo mv fabric /usr/local/bin/fab
          fab --version

      # 4) Install Python dependencies (if any)
      - name: ğŸ“š Install Python requirements
        run: |
          pip install -r scripts/requirements.txt || true

      # 5) Deploy (dev or prd)
      - name: ğŸš€ Run Deployment Script
        env:
          FABRIC_CLIENT_ID: ${{ secrets.FABRIC_CLIENT_ID }}
          FABRIC_CLIENT_SECRET: ${{ secrets.FABRIC_CLIENT_SECRET }}
          FABRIC_TENANT_ID: ${{ secrets.FABRIC_TENANT_ID }}
        run: |
          if [ "${{ github.event.inputs.environment }}" = "dev" ]; then
            echo "Deploying to DEV..."
            python scripts/deploy-dev.py \
              --spn-auth \
              --workspace "${{ github.event.inputs.workspace }}" \
              --capacity "${{ github.event.inputs.capacity }}" \
              --admin-upns "${{ github.event.inputs.admin_upns }}"
          else
            echo "Deploying to PROD..."
            python scripts/deploy-prd.py \
              --spn-auth \
              --workspace "${{ github.event.inputs.workspace }}" \
              --capacity "${{ github.event.inputs.capacity }}" \
              --admin-upns "${{ github.event.inputs.admin_upns }}"
          fi
