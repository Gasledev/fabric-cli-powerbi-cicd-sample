name: ğŸš€ Deploy to Fabric

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        required: true
        default: dev
        options:
          - dev
          - prd
      workspace:
        type: string
        required: true
        default: "MyWorkspace"
      capacity:
        type: string
        required: false
        default: ""
      admin_upns:
        type: string
        required: false
        default: ""

jobs:
  deploy:
    name: ğŸŒ Deploy Report + Semantic Model
    runs-on: ubuntu-latest

    steps:
      
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: ğŸ“¦ Install Fabric CLI
        run: |
          python -m pip install ms-fabric-cli

      - name: ğŸ”§ Install Python dependencies
        run: |
          pip install -r ./scripts/requirements.txt || true

      - name: ğŸš€ Run deployment script
        env:
          FABRIC_CLIENT_ID: ${{ secrets.FABRIC_CLIENT_ID }}
          FABRIC_CLIENT_SECRET: ${{ secrets.FABRIC_CLIENT_SECRET }}
          FABRIC_TENANT_ID: ${{ secrets.FABRIC_TENANT_ID }}
        run: |
          if [ "${{ github.event.inputs.environment }}" = "dev" ]; then
              python scripts/deploy-dev.py \
                --spn-auth \
                --workspace "${{ github.event.inputs.workspace }}" \
                --capacity "${{ github.event.inputs.capacity }}" \
                --admin-upns "${{ github.event.inputs.admin_upns }}"
          else
              python scripts/deploy-prd.py \
                --spn-auth \
                --workspace "${{ github.event.inputs.workspace }}" \
                --capacity "${{ github.event.inputs.capacity }}" \
                --admin-upns "${{ github.event.inputs.admin_upns }}"
          fi
